<div>
  <div class="text-lg font-semibold text-base-content/75">Cap and Redistribute Options</div>

  <div class="flex flex-wrap gap-4 items-center pt-2">
    <% if portfolio.cap_and_redistribute_options.present? %>
      <% portfolio.cap_and_redistribute_options.each do |option| %>
        <% disabled_class = option.active ? "bg-base-100" : "opacity-50 bg-base-300"
        toggle_button_class = cap_and_redistribute_toggle_class(option.active) %>
        <div
          class="flex gap-6 items-center p-2 max-w-xs border shadow-sm  border-base-300 h-fit min-w-3xs w-fit <%= disabled_class %>"
        >
          <div class="flex justify-between items-center w-full">
            <div class="block shrink truncate">
              <p class="text-sm font-semibold">Cap:
                <%= format_percentage(option.cap_percentage * 100) %>%</p>
              <p class="text-xs text-base-content/60">Top N:
                <%= option.top_n %></p>
            </div>
          </div>
          <div class="flex gap-2 items-center">
            <%= button_to option.active ? "Active" : "View",
            portfolio_path(portfolio),
            method: :patch,
            params: {
              toggle_cap_and_redistribute_option: option.id,
              update_cap_and_redistribute_options: "true",
            },
            class: toggle_button_class %>

            <%= button_to "Remove",
            portfolio_path(portfolio),
            method: :patch,
            params: {
              remove_cap_and_redistribute_option: option.id,
              update_cap_and_redistribute_options: "true",
            },
            data: {
              turbo_confirm: "Are you sure you want to remove this option?",
            },
            class: "btn btn-error btn-soft btn-xs" %>
          </div>
        </div>
      <% end %>

      <div
        class="tooltip"
        data-tip="Disables any active cap and redistribute options and shows the base portfolio."
      >
        <%= button_to "View Base Portfolio",
        portfolio_path(portfolio),
        method: :patch,
        params: {
          clear_cap_and_redistribute_options: "true",
          update_cap_and_redistribute_options: "true",
        },
        class: "btn btn-xs" %>
      </div>
    <% else %>
      <p class="text-sm italic text-base-content/25">No cap and redistribute options added yet.</p>
    <% end %>
  </div>
  <div class="pt-4 font-semibold text-base-content/75">Create a Cap and Redistribute View</div>
  <p class="pt-2 pb-1 text-xs text-base-content/50">
    <span class="font-semibold">
      Cap
    </span>
    the maximum weight percentage for any given stock in the portfolio.
  </p>
  <p class="pb-1 text-xs text-base-content/50">
    <span class="font-semibold">
      Redistribute
    </span>
    the excess weight percentage from the cap to the top
    <i>N</i>
    stocks based on prior-year performance.
  </p>

  <%= form_with(model: portfolio, url: portfolio_path(portfolio), method: :patch) do |cap_redistribute_form| %>
    <div class="flex flex-col gap-4 pt-2 lg:flex-row lg:items-center">
      <%= cap_redistribute_form.hidden_field :portfolio_id, value: portfolio.id %>

      <%= cap_redistribute_form.number_field :cap_percentage,
                                         placeholder: "Cap percentage, e.g. \"8.0\"",
                                         class: "input input-sm",
                                         step: 0.01,
                                         min: 0,
                                         max: 100 %>

      <%= cap_redistribute_form.number_field :top_n,
                                         placeholder: "Top N stocks, e.g. \"3\"",
                                         class: "input input-sm",
                                         step: 1,
                                         min: 1,
                                         max: [
                                           Array(portfolio.current_tickers).length,
                                           1,
                                         ].max %>

      <%= cap_redistribute_form.hidden_field :update_cap_and_redistribute_options,
                                         value: "true" %>

      <div>
        <%= cap_redistribute_form.submit "Add Option",
                                     class: "btn btn-soft btn-success btn-xs" %>
      </div>
    </div>
  <% end %>
  <p class="pt-2 text-xs font-medium text-base-content/50">
    <span class="font-bold">NOTE</span>: Adding an option saves it for later use. To apply cap and redistribute
    settings, use the "Apply" button which will create a new portfolio
    version.</p>
</div>
