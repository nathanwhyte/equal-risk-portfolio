<div>
  <div class="text-lg font-semibold text-base-content/75">Cap and Redistribute
    <% if @portfolio.cap_and_redistribute_options.present? && @portfolio.cap_and_redistribute_options.any?(&:active) %>
      <span class="ml-2 font-medium badge badge-sm badge-warning">Active</span>
    <% end %>
  </div>

  <div class="flex flex-wrap gap-4 items-center pt-2">
    <% if portfolio.cap_and_redistribute_options.present? %>
      <% portfolio.cap_and_redistribute_options.each do |option| %>
        <% disabled_class = option.active ? "bg-base-100" : "opacity-50 bg-base-300"
        toggle_button_class =
          (
            if option.active
              "btn btn-disabled text-accent btn-xs btn-ghost"
            else
              "btn btn-xs btn-accent btn-soft"
            end
          ) %>
        <div
          class="flex gap-10 items-center p-2 border shadow-sm  border-base-300 h-fit <%= disabled_class %>"
        >
          <div class="flex justify-between items-center w-full">
            <div class="block shrink truncate">
              <p>
                <span class="font-semibold">Capped</span>
                at
                <span class="font-bold text-primary">
                  <%= format_percentage(option.cap_percentage * 100) %>%
                </span>
              </p>
              <p>
                <span class="font-semibold">Redistributed</span>
                to top
                <span class="font-bold text-primary"><%= option.top_n %></span>
              </p>
            </div>
          </div>
          <div class="flex gap-2 items-center">
            <%= button_to option.active ? "Viewing" : "View",
            portfolio_path(portfolio),
            method: :patch,
            params: {
              toggle_cap_and_redistribute_option: option.id,
              update_cap_and_redistribute_options: "true",
            },
            class: toggle_button_class %>

            <%= button_to "Delete",
            portfolio_path(portfolio),
            method: :patch,
            params: {
              remove_cap_and_redistribute_option: option.id,
              update_cap_and_redistribute_options: "true",
            },
            data: {
              turbo_confirm: "Are you sure you want to delete this option?",
            },
            class: "btn btn-error btn-soft btn-xs" %>
          </div>
        </div>
      <% end %>

      <div
        class="tooltip"
        data-tip="Disables any active cap and redistribute views and shows the base portfolio."
      >
        <%= button_to "View Base Portfolio",
        portfolio_path(portfolio),
        method: :patch,
        params: {
          clear_cap_and_redistribute_options: "true",
          update_cap_and_redistribute_options: "true",
        },
        class: "btn btn-xs" %>
      </div>
    <% else %>
      <p class="text-sm italic text-base-content/25">No cap and redistribute views configured.</p>
    <% end %>
  </div>
  <div class="pt-4 font-semibold text-base-content/75">Create a Cap and Redistribute View</div>
  <% if portfolio.errors[:cap_and_redistribute_options].any? %>
    <div class="pt-2 alert alert-error">
      <ul class="list-disc list-inside">
        <% portfolio.errors[:cap_and_redistribute_options].each do |error| %>
          <li><%= error %></li>
        <% end %>
      </ul>
    </div>
  <% end %>
  <p class="pt-2 pb-1 text-xs text-base-content/50">
    <span class="font-semibold">
      Cap
    </span>
    the maximum weight percentage for any given stock in the portfolio.
  </p>
  <p class="pb-1 text-xs text-base-content/50">
    <span class="font-semibold">
      Redistribute
    </span>
    any excess weight percentage from the cap evenly between the top
    <i>N</i>
    stocks based on prior-year growth performance.
  </p>

  <%= form_with(model: portfolio, url: portfolio_path(portfolio), method: :patch) do |cap_redistribute_form| %>
    <div class="flex flex-col gap-4 pt-2 lg:flex-row lg:items-center">
      <%= cap_redistribute_form.hidden_field :portfolio_id, value: portfolio.id %>

      <%= cap_redistribute_form.number_field :cap_percentage,
                                         placeholder: "Cap percentage, e.g. \"8.0\"",
                                         class: "input input-sm",
                                         step: 0.01,
                                         min: 0,
                                         max: 100 %>

      <%= cap_redistribute_form.number_field :top_n,
                                         placeholder: "Top N stocks, e.g. \"3\"",
                                         class: "input input-sm",
                                         step: 1,
                                         min: 1,
                                         max: [
                                           Array(portfolio.current_tickers).length -
                                             1,
                                           1,
                                         ].max %>

      <%= cap_redistribute_form.hidden_field :update_cap_and_redistribute_options,
                                         value: "true" %>

      <div>
        <%= cap_redistribute_form.submit "Create", class: "btn btn-soft btn-success btn-xs" %>
      </div>
    </div>
  <% end %>
  <p class="pt-3 text-xs text-base-content/50">
    <span class="font-semibold">
      Note:
    </span>
    Newly created cap and redistribute views
    <u>will apply changes to the original portfolio weights</u>.
  </p>
  <p class="pt-1 text-xs text-base-content/50">
    Use the
    <span class="font-semibold">"View Base Portfolio"</span>
    button view portfolio without any "Cap and Redistribute" views applied.
  </p>
</div>
